generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Supplier {
  id            Int       @id @default(autoincrement())
  name          String    @unique @db.VarChar(255)
  contactEmail  String?   @map("contact_email") @db.VarChar(255)
  contactPhone  String?   @map("contact_phone") @db.VarChar(50)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  purchases     InventoryPurchase[]

  @@map("suppliers")
}

model Product {
  id                    Int       @id @default(autoincrement())
  baseName              String    @map("base_name") @db.VarChar(255)
  sizeMm                Decimal   @map("size_mm") @db.Decimal(5, 2)
  qualityGrade          QualityGrade @map("quality_grade") @default(NORMAL)
  sku                   String    @unique @db.VarChar(100)
  baziElement           BaziElement? @map("bazi_element")
  metaphysicalProperties Json?    @map("metaphysical_properties")
  description           String?   @db.Text
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  purchases             InventoryPurchase[]
  stock                 InventoryStock?
  mediaFiles            MediaFile[]
  aiContent             AiGeneratedContent[]

  @@index([baziElement])
  @@index([qualityGrade])
  @@index([isActive])
  @@map("products")
}

model InventoryPurchase {
  id                Int       @id @default(autoincrement())
  productId         Int       @map("product_id")
  supplierId        Int       @map("supplier_id")
  quantityPurchased Int       @map("quantity_purchased")
  weightGrams       Decimal   @map("weight_grams") @db.Decimal(8, 2)
  costTotal         Decimal   @map("cost_total") @db.Decimal(10, 2)
  markupPercentage  Decimal   @map("markup_percentage") @db.Decimal(5, 2) @default(40.00)
  qualityRating     Int?      @map("quality_rating") @db.TinyInt
  purchaseDate      DateTime  @map("purchase_date") @db.Date
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")

  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier          Supplier  @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  @@index([productId])
  @@index([supplierId])
  @@index([purchaseDate])
  @@map("inventory_purchases")
}

model InventoryStock {
  id                   Int       @id @default(autoincrement())
  productId            Int       @unique @map("product_id")
  quantityAvailable    Int       @default(0) @map("quantity_available")
  weightGramsAvailable Decimal   @default(0) @map("weight_grams_available") @db.Decimal(8, 2)
  avgCostPerGram       Decimal?  @map("avg_cost_per_gram") @db.Decimal(10, 4)
  lastRestockDate      DateTime? @map("last_restock_date") @db.Date
  updatedAt            DateTime  @updatedAt @map("updated_at")

  product              Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("inventory_stock")
}

model MediaFile {
  id            Int       @id @default(autoincrement())
  productId     Int       @map("product_id")
  filePath      String    @map("file_path") @db.VarChar(500)
  fileType      FileType  @map("file_type")
  isPrimary     Boolean   @default(false) @map("is_primary")
  platformTags  Json?     @map("platform_tags")
  displayOrder  Int       @default(0) @map("display_order")
  createdAt     DateTime  @default(now()) @map("created_at")

  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("media_files")
}

model AiGeneratedContent {
  id                 Int       @id @default(autoincrement())
  productId          Int       @map("product_id")
  contentType        ContentType @map("content_type")
  userBaziChartHash  String?   @map("user_bazi_chart_hash") @db.VarChar(64)
  platform           String?   @db.VarChar(20)
  generatedContent   Json      @map("generated_content")
  sourceFactsUsed    Json?     @map("source_facts_used")
  confidenceScore    Decimal?  @map("confidence_score") @db.Decimal(3, 2)
  humanVerified      Boolean   @default(false) @map("human_verified")
  createdAt          DateTime  @default(now()) @map("created_at")

  product            Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, contentType])
  @@index([humanVerified])
  @@map("ai_generated_content")
}

enum QualityGrade {
  NORMAL @map("normal")
  GOOD   @map("good")
  HIGH   @map("high")
}

enum BaziElement {
  WOOD  @map("wood")
  FIRE  @map("fire")
  EARTH @map("earth")
  METAL @map("metal")
  WATER @map("water")
}

enum FileType {
  IMAGE @map("image")
  VIDEO @map("video")
}

enum ContentType {
  BAZI_SELLING_COPY @map("bazi_selling_copy")
  VIDEO_EDIT_PROMPT @map("video_edit_prompt")
}
